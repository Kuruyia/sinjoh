# `pokeplat_utils`

This is a CLI tool that can be used to interactively manipulate PokÃ©mon Platinum data files.

## Installation

This is a Rust executable, which requires the Rust toolchain to be installed. You can install it the usual way,
using [`rustup`](https://rustup.rs/).

> [!NOTE]
> This crate requires the nightly toolchain to be installed. You can install it using the following command:
>
> ```bash
> rustup toolchain install nightly
> ```

After that, you can run or build the executable [as usual](https://doc.rust-lang.org/cargo/guide/working-on-an-existing-project.html),
using `cargo`:

```bash
cargo run --bin pokeplat_utils --release
```

```bash
cargo build --bin pokeplat_utils --release
```

If you built the executable, it will be located in the `target/release/` directory.

## Usage

The CLI integrates help for all commands. You can run the following command to see the help for the CLI:

```bash
pokeplat_utils --help
```

It is required to provide the paths to the resources files used by the game to the CLI. You can either:

- Clone the [`pret/pokeplatinum` repository](https://github.com/pret/pokeplatinum) and build the ROM. Then, use the
  `--pokeplatinum-repo-path` argument to point to the root of the repository.

  This is more involved as it requires building the ROM, but makes it easier to use the CLI as it will automatically
  find the required resource files for you.

- Provide the path to each resource file manually, using the arguments that are documented when running the CLI with
  `--help`.

The CLI is split into different subcommands. Please check the help for each subcommand to see the available options.

### SQL

The `sql` subcommand can be used to perform SQL-related operations on the game data files. This is useful if you want to
express complex queries to

You can export those files to a SQLite 3 database, which can be opened using any SQLite-compatible tool. The database
will contain all the data files supported by the tool:

```bash
pokeplat_utils --pokeplatinum-repo-path /path/to/pret/pokeplatinum sql export pokeplatinum.sqlite
```

This creates the database in the current directory, with the name `pokeplatinum.sqlite`.

You can also start an interactive REPL session to run SQL queries directly on the database:

```bash
pokeplat_utils --pokeplatinum-repo-path /path/to/pret/pokeplatinum sql repl
```

For reference, here's an entity-relationship diagram of the database generated by the tool. Please also refer to the
[file format specifications](https://github.com/pret/pokeplatinum/blob/main/docs/maps/file_format_specifications.md) of
the game for more information on the data files.

This diagram is here more to give an idea of the data structure than to be a complete reference.

```mermaid
erDiagram
%% Map headers
  map_header {
    int id
    int area_data_archive_id
    int unk
    int map_matrix_id
    int scripts_archive_id
    int init_scripts_archive_id
    int msg_archive_id
    int day_music_id
    int night_music_id
    int wild_encounters_archive_id
    int events_archive_id
    int map_label_text_id
    int map_label_window_id
    int weather
    int camera_type
    int map_type
    int battle_bg
    bool is_bike_allowed
    bool is_running_allowed
    bool is_escape_rope_allowed
    bool is_fly_allowed
  }

%% area_data.narc
  area_data {
    int id
    int area_map_prop_id
    int map_texture_id
    int area_light_id
    int dummy
  }
  map_header }|--|| area_data : references

%% area_build.narc
  area_map_prop {
    int id
    int map_prop_id
  }
  area_data }|--|| area_map_prop : references

%% arealight.narc
  area_light {
    int id
    int end_time
  }
  area_data }|--|| area_light : references

  area_light_properties {
    int light_id
    int area_light_id
    int area_light_end_time
    int red
    int green
    int blue
    int dir_x
    int dir_y
    int dir_z
  }
  area_light_properties }|--|| area_light : has

  area_light_color {
    string kind
    int area_light_id
    int area_light_end_time
    int red
    int green
    int blue
  }
  area_light_color }|--|| area_light : has

%% land_data.narc
  land_data_terrain_attributes {
    int land_data_id
    int x
    int y
    int tile_behavior
    int has_collision
  }
  land_data ||--|| land_data_terrain_attributes : has

  land_data_map_prop {
    int idx
    int land_data_id
    int map_prop_id
    int pos_x
    int pos_y
    int pos_z
    int rotation_x
    int rotation_y
    int rotation_z
    int scale_x
    int scale_y
    int scale_z
    int dummy_1
    int dummy_2
  }
  land_data ||--|| land_data_map_prop : has

  bdhc_point {
    int idx
    int land_data_id
    int pos_x
    int pos_z
  }
  land_data ||--|{ bdhc_point : has

  bdhc_normal {
    int idx
    int land_data_id
    int pos_x
    int pos_y
    int pos_z
  }
  land_data ||--|{ bdhc_normal : has

  bdhc_constant {
    int idx
    int land_data_id
    int constant
  }
  land_data ||--|{ bdhc_constant : has

  bdhc_plate {
    int idx
    int land_data_id
    int first_point_idx
    int second_point_idx
    int normal_idx
    int constant_idx
  }
  bdhc_point }|--|{ bdhc_plate : has
  bdhc_normal ||--|{ bdhc_plate : has
  bdhc_constant ||--|{ bdhc_plate : has

  bdhc_access_list {
    int idx
    int land_data_id
    int plate_idx
  }
  bdhc_plate ||--|{ bdhc_access_list : has

  bdhc_strip {
    int idx
    int land_data_id
    int scanline
    int access_list_element_count
    int access_list_start_index
  }
  bdhc_access_list }|--|{ bdhc_strip : has

%% map_matrix.narc
  map_matrix {
    int id
    int height
    int width
    string model_name_prefix
  }
  map_header }|--|| map_matrix : references

  map_matrix_altitude {
    int map_matrix_id
    int x
    int y
    int altitude
  }
  map_matrix ||--|o map_matrix_altitude : has

  map_matrix_land_data_id {
    int map_matrix_id
    int x
    int y
    int land_data_id
  }
  map_matrix ||--|{ map_matrix_land_data_id : has
  land_data ||--|{ map_matrix_land_data_id : references

  map_matrix_header_id {
    int map_matrix_id
    int x
    int y
    int map_header_id
  }
  map_matrix ||--|o map_matrix_header_id : has
  map_header }|--|| map_matrix_header_id : references

%% bm_anime_list.narc
  map_prop_animation_list {
    int id
    bool deferred_loading
    bool deferred_add_to_render_object
    bool is_bicycle_slope
  }
  area_map_prop }|--|| map_prop_animation_list : references

  map_prop_animation_list_ids {
    int animation_id
    int map_prop_animation_list_id
  }
  map_prop_animation_list ||--|o map_prop_animation_list_ids : has

%% build_model_matshp.dat
  map_prop_material_shape {
    int id
    int material_shape_ids_index
  }
  area_map_prop }|--|| map_prop_material_shape : references

  map_prop_material_shape_ids {
    int map_prop_material_shape_id
    int material_id
    int shape_id
  }
  map_prop_material_shape ||--|o map_prop_material_shape_ids : has
```

As you can see, only map-related data is supported for now.
